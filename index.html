<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì¼ ì—‘ì…€ íŒŒì¼ ì¤‘ë³µ ì œê±° ë° ë‹¹ì²¨ì ë¶„ë¦¬ ì¶”ì¶œ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif; line-height: 1.6; padding: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-top: 25px; }
        input[type="file"] { margin-bottom: 15px; display: block; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-right: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .result-area, .final-list-area { margin-top: 20px; padding: 0; border: 1px solid #ddd; background-color: #fff; border-radius: 6px; max-height: 400px; overflow-y: auto; }
        .final-list-area { border-color: #00bcd4; }
        
        .control-group { margin-bottom: 20px; padding: 10px 0; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .control-group input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 120px; margin-right: 15px; font-size: 16px; }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; background-color: #f9f9f9; }
        .checkbox-group label { font-weight: normal; }
        
        .feedback { margin-top: 15px; padding: 12px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 6px; display: none; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .column-select-tip { font-size: 0.9em; color: #6c757d; margin-bottom: 10px; }
        .action-buttons { margin-top: 15px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; word-wrap: break-word; }
        th { background-color: #e9ecef; font-weight: bold; color: #495057; border-top: 1px solid #dee2e6; }
        tr:hover { background-color: #f1f1f1; }
        .final-list-area tr:hover { background-color: #e6f7ff; }

        .data-input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; }
        .col-actions button { margin-right: 0; padding: 5px 10px; font-size: 13px; }
        
        /* ìˆ˜ë™ ì¶”ê°€ ì…ë ¥ í•„ë“œ */
        .add-data-input { display: flex; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; border: 1px dashed #ced4da; }
        .add-data-input input { flex-grow: 1; margin-right: 10px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
        
        .status-bar { padding: 10px 0; font-size: 1.1em; font-weight: bold; }
        .status-bar strong { color: #dc3545; }
        .final-list-area .status-bar strong { color: #00bcd4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ë‹¨ì¼ ì—‘ì…€ íŒŒì¼ ì¤‘ë³µ ì œê±° ë° ë‹¹ì²¨ì ë¶„ë¦¬ ì¶”ì¶œ ë„êµ¬</h1>
        <p>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³ , íŠ¹ì • ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ ì œê±°í•œ ë’¤ ëœë¤ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. í™•ì •ëœ ë‹¹ì²¨ìëŠ” ì›ë³¸ ë°ì´í„°ì—ì„œ ì œì™¸ë˜ì–´ ë‹¤ìŒ ì¶”ì²¨ì— ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

        <div class="control-group">
            <label for="fileInput">1. ì—‘ì…€ íŒŒì¼ ì„ íƒ (1ê°œë§Œ ì„ íƒ ê°€ëŠ¥)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            <button onclick="loadFileAndShowColumns()">íŒŒì¼ ì—…ë¡œë“œ ë° ì»¬ëŸ¼ í™•ì¸</button>
            <div id="fileStatus" class="feedback"></div>
        </div>

        <div class="controls">
            <h2>2. ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ì„¤ì •</h2>
            <div class="column-select-tip">ğŸ’¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ì´ ì•„ë˜ì— ì‹¤ì œ ì»¬ëŸ¼ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤. (XLSX íŒŒì¼ ì‚¬ìš© ì‹œ ì¸ì½”ë”© ì˜¤ë¥˜ ë°©ì§€)</div>
            
            <div class="control-group">
                <label>ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ ì„ íƒ (ìµœëŒ€ 2ê°œ):</label>
                <div class="checkbox-group" id="duplicateKeyCheckboxes">
                    <p>íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
            
            <div class="control-group">
                <label for="extractCount">ì¶”ì¶œí•  ë°ì´í„° ê°œìˆ˜:</label>
                <input type="number" id="extractCount" value="50" min="1">
                <button onclick="processAndExtract()">ëœë¤ ì¶”ì¶œ</button>
            </div>
            <p class="status-bar">ë‚¨ì€ ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ìˆ˜: <strong id="remainingCount">0</strong>ëª…</p>
        </div>

        <div class="controls">
            <h2>3. í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„° í¸ì§‘ (ì„ì‹œ ë‹¹ì²¨ì)</h2>
            <div class="action-buttons">
                <button onclick="confirmExtractedData()">âœ… í™•ì • ë° ë¶„ë¦¬ (ì¶”ì²¨ íšŒì°¨ ê¸°ë¡)</button>
                <button onclick="clearExtractedData()">âŒ ì·¨ì†Œ ë° ì¬ì¶”ì²¨</button>
            </div>
            <div class="result-area" id="extractedDataList">
                <p>ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œ í˜•ì‹ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
        
        <div class="controls">
            <h2>4. ìµœì¢… í™•ì •ëœ ë‹¹ì²¨ì ëª©ë¡ (<span id="finalCount">0</span>ëª…, í˜„ì¬ íšŒì°¨: <span id="currentRoundDisplay">1</span>)</h2>
            <div class="final-list-area" id="finalDataList">
                <p>í™•ì •ëœ ë‹¹ì²¨ìëŠ” ì—¬ê¸°ì— í‘œ í˜•ì‹ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <div class="add-data-input">
                <input type="text" id="finalDataInput" placeholder="ìµœì¢… ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€ (ì˜ˆ: ì»¬ëŸ¼A: ê°’1, ì»¬ëŸ¼B: ê°’2)">
                <button onclick="addFinalData()">ìˆ˜ë™ ì¶”ê°€</button>
            </div>
            <button onclick="downloadResult()">ìµœì¢… ëª©ë¡ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <script>
        let initialData = [];       // íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì›ë³¸ ë°ì´í„° (ì¤‘ë³µ ì œê±° ì „)
        let availableData = [];     // í˜„ì¬ ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„° (í™•ì • ëª©ë¡ ì œì™¸)
        let extractedData = [];     // í˜„ì¬ ì¶”ì¶œë˜ì–´ ì„ì‹œë¡œ ë³´ì—¬ì§€ëŠ” ë°ì´í„°
        let finalWinners = [];      // ìµœì¢… í™•ì •ëœ ë‹¹ì²¨ì ë°ì´í„°
        let availableHeaders = [];  // ì—‘ì…€ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì‹¤ì œ ì»¬ëŸ¼ ì´ë¦„ ì €ì¥
        let currentRound = 1;       // í˜„ì¬ ì¶”ì²¨ íšŒì°¨ ì¹´ìš´í„°

        // ì´ˆê¸° ë‚¨ì€ ë°ì´í„° ìˆ˜ ì—…ë°ì´íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            updateRemainingCount();
            document.getElementById('currentRoundDisplay').textContent = currentRound;
        });

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì œí•œ ë¡œì§ (ìµœëŒ€ 2ê°œ)
        function setupCheckboxLimit() {
            const checkboxes = document.querySelectorAll('input[name="duplicateKey"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('input[name="duplicateKey"]:checked').length;
                    if (checkedCount > 2) {
                        this.checked = false; 
                        alert('ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        }

        // ë‚¨ì€ ë°ì´í„° ìˆ˜ ì—…ë°ì´íŠ¸
        function updateRemainingCount() {
            document.getElementById('remainingCount').textContent = availableData.length;
            document.getElementById('finalCount').textContent = finalWinners.length;
            document.getElementById('currentRoundDisplay').textContent = currentRound;
        }

        // --- 1ë‹¨ê³„: íŒŒì¼ ë¡œë“œ ë° ì»¬ëŸ¼ í‘œì‹œ (ì¸ì½”ë”© ì²˜ë¦¬ ê°•í™”) ---
        function loadFileAndShowColumns() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const fileStatus = document.getElementById('fileStatus');
            const checkboxContainer = document.getElementById('duplicateKeyCheckboxes');

            fileStatus.style.display = 'none';
            fileStatus.classList.remove('error');
            fileStatus.textContent = '';
            
            if (!file) {
                fileStatus.textContent = 'ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv');
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    let workbook;
                    
                    if (isCSV) {
                        const data = e.target.result;
                        workbook = XLSX.read(data, { type: 'binary', cellDates: true, raw: false, codepage: 65001 }); 
                    } else {
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                    }

                    const sheetName = workbook.SheetNames[0]; 
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false }); 

                    if (json.length > 0 && json[0].length > 0) {
                        availableHeaders = json[0]
                            .map(h => h ? String(h).trim() : '')
                            .filter(h => h.length > 0);
                        
                        checkboxContainer.innerHTML = '';
                        if (availableHeaders.length === 0) {
                             checkboxContainer.innerHTML = '<p>ìœ íš¨í•œ ì»¬ëŸ¼ í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                             return;
                        }
                        
                        availableHeaders.forEach(header => {
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" name="duplicateKey" value="${header}"> ${header}`;
                            checkboxContainer.appendChild(label);
                        });
                        setupCheckboxLimit();

                        // ë°ì´í„° íŒŒì‹± ë° ì €ì¥
                        initialData = parseJsonToObjects(json, availableHeaders);
                        availableData = removeDuplicates(initialData, []); 
                        finalWinners = []; // ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ ìµœì¢… ëª©ë¡ ì´ˆê¸°í™”
                        currentRound = 1; // ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ íšŒì°¨ ì´ˆê¸°í™”

                        fileStatus.textContent = `íŒŒì¼ "${file.name}"ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ${availableHeaders.length}ê°œ ì»¬ëŸ¼, ${availableData.length}ê°œ ê³ ìœ  í–‰ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        fileStatus.style.display = 'block';
                        fileStatus.classList.remove('error');
                        updateRemainingCount();
                        renderFinalData(); // ìµœì¢… ëª©ë¡ ë¹„ìš°ê¸°

                    } else {
                        fileStatus.textContent = 'ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        fileStatus.classList.add('error');
                        fileStatus.style.display = 'block';
                    }
                } catch (error) {
                    console.error(`Error reading file:`, error);
                    fileStatus.textContent = `íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (CSV íŒŒì¼ì˜ ê²½ìš°, UTF-8ë¡œ ì €ì¥ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.)`;
                    fileStatus.classList.add('error');
                    fileStatus.style.display = 'block';
                }
            };
            
            if (isCSV) {
                reader.readAsBinaryString(file); 
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // JSON ë°°ì—´ì„ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function parseJsonToObjects(json, headers) {
            const data = [];
            for (let j = 1; j < json.length; j++) {
                const row = json[j];
                let rowObject = {};
                let hasData = false;
                
                headers.forEach((header, index) => {
                    const value = row[index] !== undefined && row[index] !== null ? String(row[index]).trim() : ''; 
                    rowObject[header] = value;
                    if (value.length > 0) {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                   data.push(rowObject);
                }
            }
            return data;
        }
        
        // ì¤‘ë³µ ì œê±° ë° í™•ì • ëª©ë¡ ì œì™¸ ë¡œì§
        function removeDuplicates(dataArray, excludeArray) {
             const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);

             if (selectedKeys.length === 0) {
                 return dataArray.filter(row => Object.values(row).some(v => String(v).trim().length > 0));
             }

             const uniqueData = {};
             
             const excludedKeys = new Set();
             excludeArray.forEach(row => {
                 const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                 if (key.replace(/\|\|\|/g, '').length > 0) {
                     excludedKeys.add(key);
                 }
             });

             dataArray.forEach(row => {
                 const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                 
                 if (key.replace(/\|\|\|/g, '').length > 0 && !excludedKeys.has(key)) {
                     uniqueData[key] = row; 
                 }
             });
             
             return Object.values(uniqueData);
        }

        // --- 2ë‹¨ê³„: ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ---
        function processAndExtract() {
            const extractCount = parseInt(document.getElementById('extractCount').value);
            const fileStatus = document.getElementById('fileStatus');
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            
            fileStatus.style.display = 'none';

            if (initialData.length === 0 || availableHeaders.length === 0) {
                fileStatus.textContent = 'ë¨¼ì € íŒŒì¼ì„ ë¡œë“œí•˜ê³  ì»¬ëŸ¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (selectedKeys.length === 0) {
                fileStatus.textContent = 'ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì„ 1ê°œ ë˜ëŠ” 2ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (extractCount <= 0 || isNaN(extractCount)) {
                fileStatus.textContent = 'ìœ íš¨í•œ ì¶”ì¶œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            availableData = removeDuplicates(initialData, finalWinners); 
            
            if (availableData.length === 0) {
                fileStatus.textContent = 'ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                renderExtractedData();
                return;
            }

            let dataToExtract = [...availableData];
            let actualCount = Math.min(extractCount, dataToExtract.length);
            
            const shuffled = dataToExtract.sort(() => 0.5 - Math.random());
            extractedData = shuffled.slice(0, actualCount);

            renderExtractedData();
            updateRemainingCount();
            
            fileStatus.textContent = `${availableData.length}ê°œì˜ ë°ì´í„° ì¤‘ ${extractedData.length}ê°œë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì •í•´ì£¼ì„¸ìš”. (í˜„ì¬ ${currentRound}íšŒì°¨)`;
            fileStatus.classList.remove('error');
            fileStatus.style.display = 'block';
        }

        // --- 3ë‹¨ê³„: UI ë Œë”ë§ (í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ê°œì„ ) ---

        function renderExtractedData() {
            const extractedDataListDiv = document.getElementById('extractedDataList');
            extractedDataListDiv.innerHTML = ''; 

            if (extractedData.length === 0) {
                extractedDataListDiv.innerHTML = '<p style="padding: 15px;">ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ëœë¤ ì¶”ì¶œ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì·¨ì†Œ í›„ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë¨)</p>';
                return;
            }

            extractedDataListDiv.appendChild(createDataTable(extractedData, true));
        }
        
        function renderFinalData() {
            const finalDataListDiv = document.getElementById('finalDataList');
            finalDataListDiv.innerHTML = ''; 

            if (finalWinners.length === 0) {
                finalDataListDiv.innerHTML = '<p style="padding: 15px;">í™•ì •ëœ ë‹¹ì²¨ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            finalDataListDiv.appendChild(createDataTable(finalWinners, false));
            updateRemainingCount();
        }

        // í…Œì´ë¸” ìƒì„± í—¬í¼ í•¨ìˆ˜
        function createDataTable(dataArray, isExtractedList) {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();
            
            // ìµœì¢… ëª©ë¡ì¼ ê²½ìš°ì—ë§Œ ì¶”ê°€ì ì¸ íšŒì°¨/ë°©ë²• ì»¬ëŸ¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const displayHeaders = isExtractedList 
                ? availableHeaders
                : [...availableHeaders, 'Winning Round', 'Entry Method']; 

            // í—¤ë” í–‰ ìƒì„±
            const headerRow = thead.insertRow();
            headerRow.insertCell().textContent = 'No.';
            displayHeaders.forEach(header => {
                headerRow.insertCell().textContent = header;
            });
            headerRow.insertCell().textContent = 'ê´€ë¦¬';

            // ë°ì´í„° í–‰ ìƒì„±
            dataArray.forEach((item, index) => {
                const dataRow = tbody.insertRow();
                dataRow.insertCell().textContent = index + 1; // No.

                displayHeaders.forEach(header => {
                    const cell = dataRow.insertCell();
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.classList.add('data-input');
                    
                    // í•„ë“œ ê°’ ì„¤ì • (íšŒì°¨/ë°©ë²•ì€ ì½ê¸° ì „ìš©)
                    if (header === 'Winning Round' || header === 'Entry Method') {
                        input.value = item[header] || '';
                        input.readOnly = true; 
                        input.style.backgroundColor = '#f0f0f0';
                    } else {
                        input.value = item[header] || '';
                        // ì…ë ¥ ê°’ ë³€ê²½ ì‹œ ë°ì´í„° ê°ì²´ ì—…ë°ì´íŠ¸
                        input.onchange = (e) => {
                            item[header] = e.target.value.trim();
                        };
                    }
                    
                    cell.appendChild(input);
                });

                // ê´€ë¦¬ ë²„íŠ¼ ì…€
                const actionsCell = dataRow.insertCell();
                actionsCell.classList.add('col-actions');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ì‚­ì œ';
                
                deleteButton.onclick = () => {
                    if (isExtractedList) {
                        deleteData(extractedData, index, renderExtractedData);
                    } else {
                        const deletedItem = deleteData(finalWinners, index, renderFinalData);
                        if (deletedItem && deletedItem['Entry Method'] === 'Random Draw') {
                            initialData.push(deletedItem); 
                            availableData = removeDuplicates(initialData, finalWinners); 
                            updateRemainingCount();
                            alert('í™•ì • ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ë°ì´í„°ëŠ” ì´ì œ ì¬ì¶”ì²¨ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        } else if (deletedItem && deletedItem['Entry Method'] === 'Manual Add') {
                            // ìˆ˜ë™ ì¶”ê°€ëœ ë°ì´í„°ëŠ” ì›ë³¸ initialDataì— ë³µêµ¬í•  í•„ìš” ì—†ìŒ
                            alert('ìˆ˜ë™ ì¶”ê°€ëœ í•­ëª©ì´ ìµœì¢… ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                };
                actionsCell.appendChild(deleteButton);
            });

            return table;
        }

        // ë°ì´í„° ì‚­ì œ ë¡œì§ (ì¬í™œìš©)
        function deleteData(dataArray, index, renderCallback) {
            const deletedItem = dataArray.splice(index, 1)[0];
            renderCallback();
            return deletedItem;
        }

        // í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ìµœì¢… ëª©ë¡ìœ¼ë¡œ í™•ì •í•˜ê³  ì›ë³¸ì—ì„œ ì œê±°
        function confirmExtractedData() {
            if (extractedData.length === 0) {
                alert('í™•ì •í•  ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const currentRoundNumber = currentRound;
            
            // 1. ìµœì¢… ëª©ë¡ì— ì¶”ê°€ (íšŒì°¨ ì •ë³´ì™€ ë°©ë²•ì„ ì¶”ê°€)
            const winnersToConfirm = extractedData.map(item => {
                return { ...item, 
                         'Winning Round': currentRoundNumber, 
                         'Entry Method': 'Random Draw' 
                       };
            });
            finalWinners.push(...winnersToConfirm);

            // 2. ì›ë³¸ ë°ì´í„° (initialData)ì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            if (selectedKeys.length > 0) {
                const extractedKeys = new Set(extractedData.map(row => 
                    selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||')
                ));

                initialData = initialData.filter(row => {
                    const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                    return !extractedKeys.has(key);
                });
            } else {
                alert('ê²½ê³ : ì¤‘ë³µ ì œê±° ê¸°ì¤€ì´ ì„ íƒë˜ì§€ ì•Šì•„, ì›ë³¸ ë°ì´í„°ì—ì„œ ì •í™•í•œ í•­ëª© ì œê±°ê°€ ì–´ë µìŠµë‹ˆë‹¤. ìµœì¢… ëª©ë¡ì—ë§Œ ì¶”ê°€í•˜ê³ , ì›ë³¸ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.');
            }

            // 3. ì¶”ì¶œëœ ëª©ë¡ ë¹„ìš°ê¸° ë° ë‹¤ìŒ íšŒì°¨ë¡œ ì¦ê°€
            extractedData = [];
            currentRound++; // íšŒì°¨ ì¦ê°€
            availableData = removeDuplicates(initialData, finalWinners); 

            // 4. UI ê°±ì‹ 
            renderExtractedData();
            renderFinalData();
            updateRemainingCount();
            alert(`ì´ ${finalWinners.length}ëª…ì˜ ë‹¹ì²¨ìê°€ ìµœì¢… í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¶”ì²¨ì€ ${currentRound}íšŒì°¨ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.`);
        }
        
        // í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ì·¨ì†Œí•˜ê³  ì¬ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ë¡œ ë˜ëŒë¦¼
        function clearExtractedData() {
            if (extractedData.length === 0) return;
            
            extractedData = [];
            renderExtractedData();
            alert('í˜„ì¬ ì¶”ì¶œëœ ëª©ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì¶œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        }

        // ìµœì¢… í™•ì • ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€
        function addFinalData() {
            const newDataInput = document.getElementById('finalDataInput');
            const newValueString = newDataInput.value.trim();

            if (newValueString) {
                const parts = newValueString.split(',').map(part => part.trim()).filter(part => part.includes(':'));
                let newObject = {};
                let isValid = true;

                parts.forEach(part => {
                    const match = part.match(/(.+?)\s*:\s*(.*)/); 
                    if (match && match[1] && match[2]) {
                        const key = match[1].trim();
                        const value = match[2].trim();
                        newObject[key] = value;
                    } else {
                        isValid = false;
                    }
                });
                
                if (Object.keys(newObject).length > 0 && isValid) {
                    // ìˆ˜ë™ ì¶”ê°€ ì‹œ íšŒì°¨ ì •ë³´ ë° ë°©ë²•ì„ ê¸°ë¡
                    newObject['Winning Round'] = 'Manual';
                    newObject['Entry Method'] = 'Manual Add';

                    finalWinners.push(newObject);
                    availableData = removeDuplicates(initialData, finalWinners); 

                    newDataInput.value = ''; 
                    renderFinalData();
                    alert('ë°ì´í„°ê°€ ìµœì¢… ëª©ë¡ì— ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ìœ íš¨í•œ "ì»¬ëŸ¼: ê°’" ìŒ(ì˜ˆ: í…”ë ˆê·¸ë¨ ID: @user, í•¸ë“œí° ë²ˆí˜¸: 010-...)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìµœì¢… í™•ì • ëª©ë¡ë§Œ)
        function downloadResult() {
            if (finalWinners.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ìµœì¢… í™•ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë‹¤ìš´ë¡œë“œ ì‹œ "No." ì»¬ëŸ¼ì„ ì¶”ê°€
            const exportData = finalWinners.map((item, index) => {
                 return { "No.": index + 1, ...item };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ìµœì¢…_ë‹¹ì²¨ì_ëª©ë¡");
            XLSX.writeFile(wb, "ìµœì¢…_ë‹¹ì²¨ì_ëª©ë¡.xlsx");
        }
    </script>
</body>
</html>
