<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì¼ ì—‘ì…€ íŒŒì¼ ì¤‘ë³µ ì œê±° ë° ëœë¤ ì¶”ì¶œ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        input[type="file"] { margin-bottom: 15px; display: block; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        .result-area { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background-color: #e9ecef; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        .result-item:last-child { border-bottom: none; }
        .result-item input[type="text"] { flex-grow: 1; margin-right: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .control-buttons button { padding: 5px 10px; font-size: 14px; margin-left: 5px; }
        .controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .control-group input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; margin-right: 10px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
        .checkbox-group label { font-weight: normal; }
        .add-data-input { display: flex; margin-top: 10px; }
        .add-data-input input { flex-grow: 1; margin-right: 10px; }
        .feedback { margin-top: 15px; padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px; display: none; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .column-select-tip { font-size: 0.9em; color: gray; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ë‹¨ì¼ ì—‘ì…€ íŒŒì¼ ì¤‘ë³µ ì œê±° ë° ëœë¤ ì¶”ì¶œ ë„êµ¬</h1>
        <p>ì—‘ì…€ íŒŒì¼ì„ 1ê°œ ì—…ë¡œë“œí•œ í›„, ì‹¤ì œ ì»¬ëŸ¼ ì´ë¦„ì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ ì œê±°í•˜ê³  ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>

        <div class="control-group">
            <label for="fileInput">1. ì—‘ì…€ íŒŒì¼ ì„ íƒ (1ê°œë§Œ ì„ íƒ ê°€ëŠ¥)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            <button onclick="loadFileAndShowColumns()">íŒŒì¼ ì—…ë¡œë“œ ë° ì»¬ëŸ¼ í™•ì¸</button>
            <div id="fileStatus" class="feedback"></div>
        </div>

        <div class="controls">
            <h2>2. ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ì„¤ì •</h2>
            <div class="column-select-tip">ğŸ’¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ì´ ì•„ë˜ì— ì‹¤ì œ ì»¬ëŸ¼ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤. (íŒŒì¼ëª…ì— ë”°ë¼ í•œê¸€ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ .xlsx íŒŒì¼ ì‚¬ìš© ê¶Œì¥)</div>
            
            <div class="control-group">
                <label>ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ ì„ íƒ (ìµœëŒ€ 2ê°œ):</label>
                <div class="checkbox-group" id="duplicateKeyCheckboxes">
                    <p>íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
            
            <div class="control-group">
                <label for="extractCount">ì¶”ì¶œí•  ë°ì´í„° ê°œìˆ˜:</label>
                <input type="number" id="extractCount" value="100" min="1">
                <button onclick="processAndExtract()">ëœë¤ ì¶”ì¶œ</button>
            </div>
        </div>

        <div class="controls">
            <h2>3. ì¶”ì¶œëœ ë°ì´í„° í¸ì§‘ ë° ê²°ê³¼</h2>
            <div class="result-area" id="extractedDataList">
                <p>ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            
            <div class="add-data-input">
                <input type="text" id="newDataInput" placeholder="ì¶”ê°€í•  ë°ì´í„° (ì˜ˆ: ì»¬ëŸ¼A: ê°’1, ì»¬ëŸ¼B: ê°’2, ...)">
                <button onclick="addData()">ì¶”ê°€</button>
            </div>
            <button onclick="downloadResult()">ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <script>
        let allProcessedData = []; 
        let extractedData = [];   
        let availableHeaders = []; // ì—‘ì…€ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì‹¤ì œ ì»¬ëŸ¼ ì´ë¦„ ì €ì¥

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì œí•œ ë¡œì§ (ìµœëŒ€ 2ê°œ)
        function setupCheckboxLimit() {
            const checkboxes = document.querySelectorAll('input[name="duplicateKey"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('input[name="duplicateKey"]:checked').length;
                    if (checkedCount > 2) {
                        this.checked = false; 
                        alert('ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        }
        
        // --- 1ë‹¨ê³„: íŒŒì¼ ë¡œë“œ ë° ì»¬ëŸ¼ í‘œì‹œ ---
        function loadFileAndShowColumns() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const fileStatus = document.getElementById('fileStatus');
            const checkboxContainer = document.getElementById('duplicateKeyCheckboxes');

            fileStatus.style.display = 'none';
            fileStatus.classList.remove('error');
            fileStatus.textContent = '';
            
            if (!file) {
                fileStatus.textContent = 'ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤. (ì¸ì½”ë”© ë¬¸ì œ ë°œìƒ ì‹œ íŒŒì¼ í˜•ì‹ì„ XLSXë¡œ ë³€ê²½ ê¶Œì¥)
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0]; 
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // raw: true ì˜µì…˜ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ, ìˆ«ì/ë‚ ì§œ ë“±ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false }); 

                    if (json.length > 0) {
                        // ì‹¤ì œ í—¤ë” ì¶”ì¶œ ë° ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ê³µë°±/null ê°’ ì œê±° ë° trim ì²˜ë¦¬)
                        availableHeaders = json[0]
                            .map(h => h ? String(h).trim() : '')
                            .filter(h => h.length > 0);
                        
                        // ì»¬ëŸ¼ ì„ íƒ UI ë™ì  ìƒì„±
                        checkboxContainer.innerHTML = '';
                        if (availableHeaders.length === 0) {
                             checkboxContainer.innerHTML = '<p>ìœ íš¨í•œ ì»¬ëŸ¼ í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                             return;
                        }
                        
                        availableHeaders.forEach(header => {
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" name="duplicateKey" value="${header}"> ${header}`;
                            checkboxContainer.appendChild(label);
                        });
                        setupCheckboxLimit(); // ìƒˆë¡œ ìƒì„±ëœ ì²´í¬ë°•ìŠ¤ì— ì œí•œ ë¡œì§ ì ìš©

                        // ë°ì´í„° íŒŒì‹± ë° ì €ì¥
                        allProcessedData = parseJsonToObjects(json, availableHeaders);
                        
                        fileStatus.textContent = `íŒŒì¼ "${file.name}"ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ${availableHeaders.length}ê°œ ì»¬ëŸ¼, ${allProcessedData.length}ê°œ í–‰ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        fileStatus.style.display = 'block';
                        fileStatus.classList.remove('error');

                    } else {
                        fileStatus.textContent = 'ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        fileStatus.classList.add('error');
                        fileStatus.style.display = 'block';
                    }
                } catch (error) {
                    console.error(`Error reading file:`, error);
                    fileStatus.textContent = `íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                    fileStatus.classList.add('error');
                    fileStatus.style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // JSON ë°°ì—´ì„ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function parseJsonToObjects(json, headers) {
            const data = [];
            for (let j = 1; j < json.length; j++) {
                const row = json[j];
                let rowObject = {};
                let hasData = false;
                
                headers.forEach((header, index) => {
                    // ëª¨ë“  ê°’ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                    const value = row[index] !== undefined && row[index] !== null ? String(row[index]).trim() : ''; 
                    rowObject[header] = value;
                    if (value.length > 0) {
                        hasData = true; // ë¹ˆ í–‰ ì œì™¸ë¥¼ ìœ„í•´
                    }
                });
                
                if (hasData) {
                   data.push(rowObject);
                }
            }
            return data;
        }

        // --- 2ë‹¨ê³„: ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ---
        function processAndExtract() {
            const extractCount = parseInt(document.getElementById('extractCount').value);
            const fileStatus = document.getElementById('fileStatus');
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            
            fileStatus.style.display = 'none';

            if (allProcessedData.length === 0 || availableHeaders.length === 0) {
                fileStatus.textContent = 'ë¨¼ì € íŒŒì¼ì„ ë¡œë“œí•˜ê³  ì»¬ëŸ¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (selectedKeys.length === 0) {
                fileStatus.textContent = 'ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì„ 1ê°œ ë˜ëŠ” 2ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (extractCount <= 0 || isNaN(extractCount)) {
                fileStatus.textContent = 'ìœ íš¨í•œ ì¶”ì¶œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            // 1. ì¤‘ë³µ ì œê±° ì‹¤í–‰
            const uniqueData = {};
            allProcessedData.forEach(row => {
                // ì¤‘ë³µ ì œê±° í‚¤ ìƒì„±: ì„ íƒëœ 1ê°œ ë˜ëŠ” 2ê°œ ì»¬ëŸ¼ì˜ ê°’ì„ ì†Œë¬¸ì/trimí•˜ì—¬ ê²°í•©
                const uniqueKeyParts = selectedKeys.map(key => String(row[key] || '').trim().toLowerCase());
                const uniqueKey = uniqueKeyParts.join('|||');
                
                // í‚¤ê°€ ì¡´ì¬í•˜ê³  (ëª¨ë‘ ë¹ˆ ê°’ì´ ì•„ë‹Œ ê²½ìš°)ì—ë§Œ ì €ì¥
                if (uniqueKey.replace(/\|\|\|/g, '').length > 0) {
                    uniqueData[uniqueKey] = row; 
                }
            });
            const finalUniqueData = Object.values(uniqueData);

            // 2. ëœë¤ ì¶”ì¶œ
            if (extractCount > finalUniqueData.length) {
                extractedData = [...finalUniqueData];
                alert(`ìš”ì²­í•œ ê°œìˆ˜(${extractCount}ê°œ)ê°€ ê³ ìœ  ë°ì´í„°(${finalUniqueData.length}ê°œ)ë³´ë‹¤ ë§ì•„, ëª¨ë“  ê³ ìœ  ë°ì´í„°ê°€ ì¶”ì¶œë©ë‹ˆë‹¤.`);
            } else {
                const shuffled = [...finalUniqueData].sort(() => 0.5 - Math.random());
                extractedData = shuffled.slice(0, extractCount);
            }

            // 3. ê²°ê³¼ í‘œì‹œ
            renderExtractedData();
            
            fileStatus.textContent = `ì´ ${finalUniqueData.length}ê°œì˜ ê³ ìœ  ë°ì´í„° ì¤‘ ${extractedData.length}ê°œë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤. ì´ì œ ë°ì´í„°ë¥¼ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            fileStatus.classList.remove('error');
            fileStatus.style.display = 'block';
        }


        // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§
        function renderExtractedData() {
            const extractedDataListDiv = document.getElementById('extractedDataList');
            extractedDataListDiv.innerHTML = ''; 

            if (extractedData.length === 0) {
                extractedDataListDiv.innerHTML = '<p>ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            extractedData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('result-item');
                itemDiv.dataset.index = index; 

                const inputField = document.createElement('input');
                inputField.type = 'text';
                
                // ê°ì²´ë¥¼ "í‚¤: ê°’, í‚¤: ê°’" ë¬¸ìì—´ë¡œ í‘œì‹œ
                inputField.value = Object.entries(item)
                                       .filter(([key, value]) => value !== undefined && value !== null && String(value).trim() !== '') 
                                       .map(([key, value]) => `${key}: ${value}`)
                                       .join(', ');
                
                inputField.onchange = (e) => updateData(index, e.target.value); 

                const controlButtonsDiv = document.createElement('div');
                controlButtonsDiv.classList.add('control-buttons');

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ì‚­ì œ';
                deleteButton.onclick = () => deleteData(index);

                controlButtonsDiv.appendChild(deleteButton);
                itemDiv.appendChild(document.createTextNode(`${index + 1}. `));
                itemDiv.appendChild(inputField);
                itemDiv.appendChild(controlButtonsDiv);
                extractedDataListDiv.appendChild(itemDiv);
            });
        }

        // ë°ì´í„° ìˆ˜ì • (í‚¤:ê°’ íŒŒì‹±)
        function updateData(index, newValueString) {
            const parts = newValueString.split(',').map(part => part.trim()).filter(part => part.includes(':'));
            let updatedObject = {};
            parts.forEach(part => {
                // ':' ê¸°ì¤€ìœ¼ë¡œ í‚¤ì™€ ê°’ì„ ë¶„ë¦¬
                const [key, value] = part.split(/:(.*)/s).map(s => s.trim()).filter(s => s.length > 0);
                if (key && value) {
                    updatedObject[key] = value;
                }
            });

            if (Object.keys(updatedObject).length > 0) {
                extractedData[index] = updatedObject;
            } 
        }

        // ë°ì´í„° ì‚­ì œ
        function deleteData(index) {
            extractedData.splice(index, 1);
            renderExtractedData();
        }

        // ë°ì´í„° ì¶”ê°€
        function addData() {
            const newDataInput = document.getElementById('newDataInput');
            const newValueString = newDataInput.value.trim();

            if (newValueString) {
                const parts = newValueString.split(',').map(part => part.trim()).filter(part => part.includes(':'));
                let newObject = {};
                parts.forEach(part => {
                    const [key, value] = part.split(/:(.*)/s).map(s => s.trim()).filter(s => s.length > 0);
                    if (key && value) {
                        newObject[key] = value;
                    }
                });
                
                if (Object.keys(newObject).length > 0) {
                    extractedData.push(newObject);
                    newDataInput.value = ''; 
                    renderExtractedData();
                } else {
                    alert('ìœ íš¨í•œ "ì»¬ëŸ¼: ê°’" ìŒ(ì˜ˆ: í…”ë ˆê·¸ë¨ í•¸ë“¤: @user, ì§€ê°‘ì£¼ì†Œ: 0x...)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadResult() {
            if (extractedData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë‹¤ìš´ë¡œë“œ ì‹œ ê° í‚¤ë¥¼ ë³„ë„ ì»¬ëŸ¼ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì €ì¥
            const exportData = extractedData.map(item => {
                 return { ...item };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ìµœì¢…_ë°ì´í„°");
            XLSX.writeFile(wb, "ìµœì¢…_ì¶”ì¶œ_ê²°ê³¼.xlsx");
        }
    </script>
</body>
</html>
