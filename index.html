<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì¼ ì—‘ì…€ íŒŒì¼ ì¤‘ë³µ ì œê±° ë° ë‹¹ì²¨ì ë¶„ë¦¬ ì¶”ì¶œ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0056b3; }
        input[type="file"] { margin-bottom: 15px; display: block; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        .result-area, .final-list-area { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background-color: #e9ecef; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .final-list-area { background-color: #e0f7fa; border-color: #00bcd4; margin-top: 15px; }
        .result-item, .final-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        .result-item:last-child, .final-item:last-child { border-bottom: none; }
        .result-item input[type="text"], .final-item input[type="text"] { flex-grow: 1; margin-right: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .control-buttons button { padding: 5px 10px; font-size: 14px; margin-left: 5px; }
        .controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .control-group input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; margin-right: 10px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
        .checkbox-group label { font-weight: normal; }
        .add-data-input { display: flex; margin-top: 10px; }
        .add-data-input input { flex-grow: 1; margin-right: 10px; }
        .feedback { margin-top: 15px; padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px; display: none; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .column-select-tip { font-size: 0.9em; color: gray; margin-bottom: 10px; }
        .action-buttons { margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ë‹¨ì¼ ì—‘ì…€ íŒŒì¼ ì¤‘ë³µ ì œê±° ë° ë‹¹ì²¨ì ë¶„ë¦¬ ì¶”ì¶œ ë„êµ¬</h1>
        <p>ì—‘ì…€ íŒŒì¼ì„ 1ê°œ ì—…ë¡œë“œí•œ í›„, ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ ì œê±°í•˜ê³  ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. í™•ì •ëœ ë‹¹ì²¨ìëŠ” ì›ë³¸ ë°ì´í„°ì—ì„œ ì œì™¸ë˜ì–´ ë‹¤ìŒ ì¶”ì²¨ì— ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

        <div class="control-group">
            <label for="fileInput">1. ì—‘ì…€ íŒŒì¼ ì„ íƒ (1ê°œë§Œ ì„ íƒ ê°€ëŠ¥)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            <button onclick="loadFileAndShowColumns()">íŒŒì¼ ì—…ë¡œë“œ ë° ì»¬ëŸ¼ í™•ì¸</button>
            <div id="fileStatus" class="feedback"></div>
        </div>

        <div class="controls">
            <h2>2. ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ì„¤ì •</h2>
            <div class="column-select-tip">ğŸ’¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ì´ ì•„ë˜ì— ì‹¤ì œ ì»¬ëŸ¼ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤. (.xlsx íŒŒì¼ ì‚¬ìš© ê¶Œì¥)</div>
            
            <div class="control-group">
                <label>ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ ì„ íƒ (ìµœëŒ€ 2ê°œ):</label>
                <div class="checkbox-group" id="duplicateKeyCheckboxes">
                    <p>íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
            
            <div class="control-group">
                <label for="extractCount">ì¶”ì¶œí•  ë°ì´í„° ê°œìˆ˜:</label>
                <input type="number" id="extractCount" value="50" min="1">
                <button onclick="processAndExtract()">ëœë¤ ì¶”ì¶œ</button>
            </div>
            <p>ë‚¨ì€ ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ìˆ˜: <strong id="remainingCount">0</strong>ëª…</p>
        </div>

        <div class="controls">
            <h2>3. í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„° í¸ì§‘ (ì„ì‹œ ë‹¹ì²¨ì)</h2>
            <div class="result-area" id="extractedDataList">
                <p>ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <div class="action-buttons">
                <button onclick="confirmExtractedData()">âœ… í™•ì • ë° ë¶„ë¦¬</button>
                <button onclick="clearExtractedData()">âŒ ì·¨ì†Œ ë° ì¬ì¶”ì²¨</button>
            </div>
        </div>
        
        <div class="controls">
            <h2>4. ìµœì¢… í™•ì •ëœ ë‹¹ì²¨ì ëª©ë¡ (<span id="finalCount">0</span>ëª…)</h2>
            <div class="final-list-area" id="finalDataList">
                <p>í™•ì •ëœ ë‹¹ì²¨ìëŠ” ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <div class="add-data-input">
                <input type="text" id="finalDataInput" placeholder="ìµœì¢… ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€ (ì˜ˆ: ì»¬ëŸ¼A: ê°’1, ì»¬ëŸ¼B: ê°’2, ...)">
                <button onclick="addFinalData()">ì¶”ê°€</button>
            </div>
            <button onclick="downloadResult()">ìµœì¢… ëª©ë¡ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <script>
        let initialData = [];       // íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì›ë³¸ ë°ì´í„° (ì¤‘ë³µ ì œê±° ì „)
        let availableData = [];     // í˜„ì¬ ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„° (í™•ì • ëª©ë¡ ì œì™¸)
        let extractedData = [];     // í˜„ì¬ ì¶”ì¶œë˜ì–´ ì„ì‹œë¡œ ë³´ì—¬ì§€ëŠ” ë°ì´í„°
        let finalWinners = [];      // ìµœì¢… í™•ì •ëœ ë‹¹ì²¨ì ë°ì´í„°
        let availableHeaders = [];  // ì—‘ì…€ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì‹¤ì œ ì»¬ëŸ¼ ì´ë¦„ ì €ì¥

        // ì´ˆê¸° ë‚¨ì€ ë°ì´í„° ìˆ˜ ì—…ë°ì´íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            updateRemainingCount();
        });

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì œí•œ ë¡œì§ (ìµœëŒ€ 2ê°œ)
        function setupCheckboxLimit() {
            const checkboxes = document.querySelectorAll('input[name="duplicateKey"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('input[name="duplicateKey"]:checked').length;
                    if (checkedCount > 2) {
                        this.checked = false; 
                        alert('ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }
                });
            });
        }

        // ë‚¨ì€ ë°ì´í„° ìˆ˜ ì—…ë°ì´íŠ¸
        function updateRemainingCount() {
            document.getElementById('remainingCount').textContent = availableData.length;
            document.getElementById('finalCount').textContent = finalWinners.length;
        }

        // --- 1ë‹¨ê³„: íŒŒì¼ ë¡œë“œ ë° ì»¬ëŸ¼ í‘œì‹œ ---
        function loadFileAndShowColumns() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const fileStatus = document.getElementById('fileStatus');
            const checkboxContainer = document.getElementById('duplicateKeyCheckboxes');

            fileStatus.style.display = 'none';
            fileStatus.classList.remove('error');
            fileStatus.textContent = '';
            
            if (!file) {
                fileStatus.textContent = 'ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0]; 
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false }); 

                    if (json.length > 0) {
                        availableHeaders = json[0].map(h => h ? String(h).trim() : '').filter(h => h.length > 0);
                        
                        checkboxContainer.innerHTML = '';
                        if (availableHeaders.length === 0) {
                             checkboxContainer.innerHTML = '<p>ìœ íš¨í•œ ì»¬ëŸ¼ í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                             return;
                        }
                        
                        availableHeaders.forEach(header => {
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" name="duplicateKey" value="${header}"> ${header}`;
                            checkboxContainer.appendChild(label);
                        });
                        setupCheckboxLimit();

                        // ì´ˆê¸° ë°ì´í„° ì €ì¥ ë° ì¤‘ë³µ ì œê±°
                        initialData = parseJsonToObjects(json, availableHeaders);
                        availableData = removeDuplicates(initialData, []); // ì´ˆê¸°ì—ëŠ” í™•ì • ëª©ë¡ì´ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ë°°ì—´ ì „ë‹¬

                        fileStatus.textContent = `íŒŒì¼ "${file.name}"ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ${availableHeaders.length}ê°œ ì»¬ëŸ¼ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        fileStatus.style.display = 'block';
                        fileStatus.classList.remove('error');
                        updateRemainingCount();

                    } else {
                        fileStatus.textContent = 'ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        fileStatus.classList.add('error');
                        fileStatus.style.display = 'block';
                    }
                } catch (error) {
                    console.error(`Error reading file:`, error);
                    fileStatus.textContent = `íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                    fileStatus.classList.add('error');
                    fileStatus.style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // JSON ë°°ì—´ì„ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function parseJsonToObjects(json, headers) {
            const data = [];
            for (let j = 1; j < json.length; j++) {
                const row = json[j];
                let rowObject = {};
                let hasData = false;
                
                headers.forEach((header, index) => {
                    const value = row[index] !== undefined && row[index] !== null ? String(row[index]).trim() : ''; 
                    rowObject[header] = value;
                    if (value.length > 0) {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                   data.push(rowObject);
                }
            }
            return data;
        }
        
        // ì¤‘ë³µ ì œê±° ë¡œì§ (í™•ì • ëª©ë¡ê³¼ë„ ë¹„êµ)
        function removeDuplicates(dataArray, excludeArray) {
             const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);

             if (selectedKeys.length === 0) {
                 // ì¤‘ë³µ í‚¤ë¥¼ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°, ì›ë³¸ ë°ì´í„°ì—ì„œ ë¹ˆ ë°ì´í„°ë§Œ ì œê±°í•˜ê³  ë°˜í™˜
                 return dataArray.filter(row => Object.values(row).some(v => String(v).trim().length > 0));
             }

             const uniqueData = {};
             
             // 1. í™•ì • ëª©ë¡ì˜ ê³ ìœ  í‚¤ë¥¼ ë¯¸ë¦¬ ë§Œë“­ë‹ˆë‹¤.
             const excludedKeys = new Set();
             excludeArray.forEach(row => {
                 const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                 if (key.replace(/\|\|\|/g, '').length > 0) {
                     excludedKeys.add(key);
                 }
             });

             // 2. ì…ë ¥ ë°ì´í„°ì—ì„œ ì¤‘ë³µ ë° ì œì™¸ ë°ì´í„°ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
             dataArray.forEach(row => {
                 const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                 
                 if (key.replace(/\|\|\|/g, '').length > 0 && !excludedKeys.has(key)) {
                     uniqueData[key] = row; 
                 }
             });
             
             return Object.values(uniqueData);
        }

        // --- 2ë‹¨ê³„: ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ---
        function processAndExtract() {
            const extractCount = parseInt(document.getElementById('extractCount').value);
            const fileStatus = document.getElementById('fileStatus');
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            
            fileStatus.style.display = 'none';

            if (availableData.length === 0 || availableHeaders.length === 0) {
                fileStatus.textContent = 'ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (selectedKeys.length === 0) {
                fileStatus.textContent = 'ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì„ 1ê°œ ë˜ëŠ” 2ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (extractCount <= 0 || isNaN(extractCount)) {
                fileStatus.textContent = 'ìœ íš¨í•œ ì¶”ì¶œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            // 1. í˜„ì¬ availableDataì—ì„œ ì¤‘ë³µ ì œê±° ë° í™•ì • ëª©ë¡ ì œì™¸ (ì¬ì‹¤í–‰)
            // loadFileAndShowColumnsì—ì„œ ì´ˆê¸° ì¤‘ë³µ ì œê±°ë¥¼ í–ˆì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„í•´ ë‹¤ì‹œ ì‹¤í–‰
            availableData = removeDuplicates(initialData, finalWinners); 
            
            if (availableData.length === 0) {
                fileStatus.textContent = 'ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                renderExtractedData();
                return;
            }

            // 2. ëœë¤ ì¶”ì¶œ
            let dataToExtract = [...availableData];
            if (extractCount > dataToExtract.length) {
                extractedData = dataToExtract;
                alert(`ìš”ì²­í•œ ê°œìˆ˜(${extractCount}ê°œ)ê°€ ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„°(${dataToExtract.length}ê°œ)ë³´ë‹¤ ë§ì•„, ê°€ëŠ¥í•œ ëª¨ë“  ë°ì´í„°ê°€ ì¶”ì¶œë©ë‹ˆë‹¤.`);
            } else {
                const shuffled = dataToExtract.sort(() => 0.5 - Math.random());
                extractedData = shuffled.slice(0, extractCount);
            }

            // 3. ê²°ê³¼ í‘œì‹œ
            renderExtractedData();
            updateRemainingCount();
            
            fileStatus.textContent = `${availableData.length}ê°œì˜ ë°ì´í„° ì¤‘ ${extractedData.length}ê°œë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì •í•´ì£¼ì„¸ìš”.`;
            fileStatus.classList.remove('error');
            fileStatus.style.display = 'block';
        }

        // --- 3ë‹¨ê³„: ì¶”ì¶œ ëª©ë¡ ê´€ë¦¬ ---

        // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§
        function renderExtractedData() {
            const extractedDataListDiv = document.getElementById('extractedDataList');
            extractedDataListDiv.innerHTML = ''; 

            if (extractedData.length === 0) {
                extractedDataListDiv.innerHTML = '<p>ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ëœë¤ ì¶”ì¶œ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì·¨ì†Œ í›„ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë¨)</p>';
                return;
            }

            extractedData.forEach((item, index) => {
                const itemDiv = createListItem(item, index, true);
                extractedDataListDiv.appendChild(itemDiv);
            });
        }
        
        // ìµœì¢… í™•ì • ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§
        function renderFinalData() {
            const finalDataListDiv = document.getElementById('finalDataList');
            finalDataListDiv.innerHTML = ''; 

            if (finalWinners.length === 0) {
                finalDataListDiv.innerHTML = '<p>í™•ì •ëœ ë‹¹ì²¨ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            finalWinners.forEach((item, index) => {
                const itemDiv = createListItem(item, index, false);
                finalDataListDiv.appendChild(itemDiv);
            });
            updateRemainingCount();
        }

        // ëª©ë¡ ì•„ì´í…œ ìƒì„± í—¬í¼ í•¨ìˆ˜
        function createListItem(item, index, isExtractedList) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add(isExtractedList ? 'result-item' : 'final-item');

            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.value = Object.entries(item)
                                   .filter(([key, value]) => String(value).trim() !== '') 
                                   .map(([key, value]) => `${key}: ${value}`)
                                   .join(', ');
            
            // ë°ì´í„° ìˆ˜ì • ì´ë²¤íŠ¸
            inputField.onchange = (e) => {
                if (isExtractedList) {
                    updateData(extractedData, index, e.target.value);
                } else {
                    updateData(finalWinners, index, e.target.value);
                }
            };

            const controlButtonsDiv = document.createElement('div');
            controlButtonsDiv.classList.add('control-buttons');

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'ì‚­ì œ';
            deleteButton.onclick = () => {
                if (isExtractedList) {
                    deleteData(extractedData, index, renderExtractedData);
                } else {
                    // ìµœì¢… ëª©ë¡ì—ì„œ ì‚­ì œ ì‹œ, availableDataì— ë‹¤ì‹œ ì¶”ê°€ë  ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬
                    const deletedItem = deleteData(finalWinners, index, renderFinalData);
                    if (deletedItem) {
                       initialData.push(deletedItem); // ì›ë³¸ ë°ì´í„°ì—ëŠ” ë‹¤ì‹œ í¬í•¨
                       availableData = removeDuplicates(initialData, finalWinners); // ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ê°±ì‹ 
                       updateRemainingCount();
                    }
                }
            };

            controlButtonsDiv.appendChild(deleteButton);
            itemDiv.appendChild(document.createTextNode(`${index + 1}. `));
            itemDiv.appendChild(inputField);
            itemDiv.appendChild(controlButtonsDiv);
            return itemDiv;
        }

        // ë°ì´í„° ìˆ˜ì • ë¡œì§ (ì¬í™œìš©)
        function updateData(dataArray, index, newValueString) {
            const parts = newValueString.split(',').map(part => part.trim()).filter(part => part.includes(':'));
            let updatedObject = {};
            parts.forEach(part => {
                const [key, value] = part.split(/:(.*)/s).map(s => s.trim()).filter(s => s.length > 0);
                if (key && value) {
                    updatedObject[key] = value;
                }
            });

            if (Object.keys(updatedObject).length > 0) {
                dataArray[index] = updatedObject;
            } 
        }

        // ë°ì´í„° ì‚­ì œ ë¡œì§ (ì¬í™œìš©)
        function deleteData(dataArray, index, renderCallback) {
            const deletedItem = dataArray.splice(index, 1)[0];
            renderCallback();
            return deletedItem;
        }

        // í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ìµœì¢… ëª©ë¡ìœ¼ë¡œ í™•ì •í•˜ê³  ì›ë³¸ì—ì„œ ì œê±°
        function confirmExtractedData() {
            if (extractedData.length === 0) {
                alert('í™•ì •í•  ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // 1. ìµœì¢… ëª©ë¡ì— ì¶”ê°€
            finalWinners.push(...extractedData);

            // 2. ì›ë³¸ ë°ì´í„° (initialData)ì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            if (selectedKeys.length > 0) {
                const extractedKeys = new Set(extractedData.map(row => 
                    selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||')
                ));

                // initialDataì—ì„œ ì¶”ì¶œëœ í‚¤ë¥¼ ê°€ì§„ í•­ëª©ì„ ì œê±°í•©ë‹ˆë‹¤.
                initialData = initialData.filter(row => {
                    const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                    return !extractedKeys.has(key);
                });
            } else {
                // ê²½ê³ : ì¤‘ë³µ í‚¤ê°€ ì—†ìœ¼ë©´ ì •í™•í•œ ì œê±°ê°€ ì–´ë µìŠµë‹ˆë‹¤.
                alert('ê²½ê³ : ì¤‘ë³µ ì œê±° ê¸°ì¤€ì´ ì„ íƒë˜ì§€ ì•Šì•„, ì›ë³¸ ë°ì´í„°ì—ì„œ ì •í™•í•œ í•­ëª© ì œê±°ê°€ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìµœì¢… ëª©ë¡ì—ë§Œ ì¶”ê°€í•©ë‹ˆë‹¤.');
            }

            // 3. ì¶”ì¶œëœ ëª©ë¡ ë¹„ìš°ê¸° ë° ì¬ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ê°±ì‹ 
            extractedData = [];
            availableData = removeDuplicates(initialData, finalWinners); 

            // 4. UI ê°±ì‹ 
            renderExtractedData();
            renderFinalData();
            updateRemainingCount();
            alert(`ì´ ${finalWinners.length}ëª…ì˜ ë‹¹ì²¨ìê°€ ìµœì¢… í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„°: ${availableData.length}ëª…`);
        }
        
        // í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ì·¨ì†Œí•˜ê³  ì¬ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ë¡œ ë˜ëŒë¦¼
        function clearExtractedData() {
            if (extractedData.length === 0) return;
            
            // ì¶”ì¶œëœ ë°ì´í„°ëŠ” availableDataì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, simply extractedDataë§Œ ë¹„ìš°ê³  UI ê°±ì‹ 
            extractedData = [];
            renderExtractedData();
            alert('í˜„ì¬ ì¶”ì¶œëœ ëª©ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì¶œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        }

        // ìµœì¢… í™•ì • ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€
        function addFinalData() {
            const newDataInput = document.getElementById('finalDataInput');
            const newValueString = newDataInput.value.trim();

            if (newValueString) {
                const parts = newValueString.split(',').map(part => part.trim()).filter(part => part.includes(':'));
                let newObject = {};
                parts.forEach(part => {
                    const [key, value] = part.split(/:(.*)/s).map(s => s.trim()).filter(s => s.length > 0);
                    if (key && value) {
                        newObject[key] = value;
                    }
                });
                
                if (Object.keys(newObject).length > 0) {
                    finalWinners.push(newObject);
                    // ìˆ˜ë™ ì¶”ê°€ëœ ë°ì´í„°ëŠ” initialDataì™€ availableDataì—ì„œ ì¤‘ë³µ ì œê±°ë˜ì–´ì•¼ í•˜ì§€ë§Œ,
                    // ì´ ë‹¨ê³„ì—ì„œëŠ” ë³µì¡í•œ ë¡œì§ì„ í”¼í•˜ê¸° ìœ„í•´ finalWinnersì—ë§Œ ì¶”ê°€í•˜ê³  UI ê°±ì‹ ë§Œ í•©ë‹ˆë‹¤.
                    availableData = removeDuplicates(initialData, finalWinners); 

                    newDataInput.value = ''; 
                    renderFinalData();
                } else {
                    alert('ìœ íš¨í•œ "ì»¬ëŸ¼: ê°’" ìŒ(ì˜ˆ: í…”ë ˆê·¸ë¨ í•¸ë“¤: @user, ì§€ê°‘ì£¼ì†Œ: 0x...)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìµœì¢… í™•ì • ëª©ë¡ë§Œ)
        function downloadResult() {
            if (finalWinners.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ìµœì¢… í™•ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const exportData = finalWinners.map((item, index) => {
                 return { "ë²ˆí˜¸": index + 1, ...item };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ìµœì¢…_ë‹¹ì²¨ì_ëª©ë¡");
            XLSX.writeFile(wb, "ìµœì¢…_ë‹¹ì²¨ì_ëª©ë¡.xlsx");
        }
    </script>
</body>
</html>
