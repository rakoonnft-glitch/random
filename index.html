<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¹ì²¨ì ê´€ë¦¬ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff; /* ë©”ì¸ ì»¬ëŸ¬ */
            --primary-dark-color: #0056b3;
            --text-color: #212529;
            --sub-text-color: #495057;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --border-color: #e9ecef;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            padding: 30px;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: auto;
            background: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            box-sizing: border-box;
        }

        h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary-dark-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
        }

        h2 {
            font-size: 1.6em;
            font-weight: 500;
            color: var(--sub-text-color);
            margin-top: 35px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
        }
        .control-group:first-of-type {
            border-top: none;
            padding-top: 0;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 1.05em;
        }

        input[type="file"] {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            background-color: #fff;
            color: var(--text-color);
            width: fit-content;
        }

        input[type="number"] {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 100px;
            margin-right: 15px;
            font-size: 16px;
            color: var(--text-color);
            background-color: var(--card-background);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin-right: 10px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-light);
        }
        button:hover:not(:disabled) {
            background-color: var(--primary-dark-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .lock-button {
            background-color: var(--warning-color);
            color: var(--text-color);
        }
        .lock-button:hover:not(:disabled) {
            background-color: #e0a800;
        }
        .lock-button.unlocked { /* ì ê¸ˆ í•´ì œ ìƒíƒœ */
            background-color: var(--success-color);
            color: white;
        }
        .lock-button.unlocked:hover:not(:disabled) {
            background-color: #218838;
        }

        .delete-button {
            background-color: var(--danger-color);
        }
        .delete-button:hover:not(:disabled) {
            background-color: #c82333;
        }

        /* í”¼ë“œë°± ë©”ì‹œì§€ */
        .feedback {
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda; /* Light green for success */
            color: #155724; /* Dark green */
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            font-size: 0.95em;
            display: none;
            box-shadow: var(--shadow-light);
        }
        .feedback.error {
            background-color: #f8d7da; /* Light red for error */
            color: #721c24; /* Dark red */
            border-color: #f5c6cb;
        }

        .column-select-tip {
            font-size: 0.85em;
            color: var(--sub-text-color);
            margin-top: -10px;
            margin-bottom: 20px;
            padding-left: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }
        .checkbox-group label {
            font-weight: 400;
            color: var(--text-color);
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .status-bar {
            margin-top: 25px;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 500;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-light);
        }
        .status-bar strong {
            color: var(--primary-color);
        }
        .final-list-area .status-bar strong {
            color: var(--success-color);
        }

        .result-area, .final-list-area {
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-background);
            max-height: 450px;
            overflow-y: auto;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .final-list-area {
            border-color: #00bcd4; /* Accent color for final list */
        }
        .result-area p, .final-list-area p {
            padding: 20px;
            color: var(--sub-text-color);
            text-align: center;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto; /* Allow columns to size naturally */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-wrap: break-word;
            font-size: 0.95em;
        }
        th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--sub-text-color);
            border-top: 1px solid var(--border-color);
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 10;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .final-list-area tr:hover {
            background-color: #eaf6ff;
        }

        .data-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdcdc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff;
            color: var(--text-color);
        }
        .data-input:disabled {
            background-color: #eceff1;
            cursor: not-allowed;
            border-color: #e0e0e0;
        }
        .col-actions {
            white-space: nowrap; /* Prevent buttons from wrapping */
            text-align: center;
        }
        .col-actions button {
            margin: 0 5px;
            padding: 8px 12px;
            font-size: 0.85em;
            box-shadow: none;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-start; /* ì¢Œì¸¡ ì •ë ¬ */
            gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }
        .action-buttons-final {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap; /* ë°˜ì‘í˜•ì„ ìœ„í•´ ì¤„ë°”ê¿ˆ í—ˆìš© */
            gap: 10px;
            align-items: center;
            justify-content: flex-start; /* ì¢Œì¸¡ ì •ë ¬ */
        }
        .action-buttons-final button {
            margin-right: 0; /* ê¸°ë³¸ ë²„íŠ¼ ë§ˆì§„ ì œê±° */
        }

        /* ìˆ˜ë™ ì¶”ê°€ ì…ë ¥ í•„ë“œ */
        .add-data-input {
            display: flex;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--background-color);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
            gap: 10px;
        }
        .add-data-input input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 1em;
            color: var(--text-color);
            background-color: var(--card-background);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .add-data-input input:disabled {
            background-color: #eceff1;
            cursor: not-allowed;
        }
        .add-data-input button {
            padding: 12px 20px;
            flex-shrink: 0; /* ë²„íŠ¼ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
        }

        /* ì²´í¬ë°•ìŠ¤ ë””ìì¸ ì¡°ì • */
        input[type="checkbox"] {
            margin-right: 8px;
            width: 1.1em;
            height: 1.1em;
            vertical-align: middle;
            position: relative;
            top: -1px;
            accent-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì·¨í•© ê´€ë¦¬</h1>
        <p>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì¤‘ë³µì„ ì œê±°í•˜ê³ , ì§€ì •ëœ ì¡°ê±´ì— ë”°ë¼ ëœë¤ìœ¼ë¡œ ë‹¹ì²¨ìë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. í™•ì •ëœ ë‹¹ì²¨ìëŠ” ë‹¤ìŒ ì¶”ì²¨ì—ì„œ ìë™ìœ¼ë¡œ ì œì™¸ë˜ë©°, ëª¨ë“  ì¶”ì²¨ ë‚´ì—­ì´ ê¸°ë¡ë©ë‹ˆë‹¤.</p>

        <div class="control-group">
            <label for="fileInput">1. ì—‘ì…€ íŒŒì¼ ì„ íƒ (ë‹¨ì¼ íŒŒì¼ë§Œ ì§€ì›)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            <button onclick="loadFileAndShowColumns()">íŒŒì¼ ì—…ë¡œë“œ ë° ì»¬ëŸ¼ í™•ì¸</button>
            <div id="fileStatus" class="feedback"></div>
        </div>

        <div class="control-group">
            <h2>2. ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ì„¤ì •</h2>
            <div class="column-select-tip">ğŸ’¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì»¬ëŸ¼ ì„ íƒì„ ì™„ë£Œí•´ì£¼ì„¸ìš”. ì¤‘ë³µ ê¸°ì¤€ ë³€ê²½ ì‹œ, ì•„ë˜ ì¶”ì²¨ ê°€ëŠ¥ ì¸ì›ìˆ˜ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</div>
            
            <label>ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ ì„ íƒ (ìµœëŒ€ 2ê°œ):</label>
            <div class="checkbox-group" id="duplicateKeyCheckboxes">
                <p>íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
            </div>
            
            <label for="extractCount">ì¶”ì¶œí•  ë‹¹ì²¨ì ìˆ˜:</label>
            <input type="number" id="extractCount" value="50" min="1">
            <button onclick="processAndExtract()">ëœë¤ ë‹¹ì²¨ì ì¶”ì¶œ</button>
            
            <div class="status-bar">
                ë‚¨ì€ ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ìˆ˜: <strong id="remainingCount">0</strong>ëª…
            </div>
        </div>

        <div class="control-group">
            <h2>3. í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„° í¸ì§‘ (ì„ì‹œ ë‹¹ì²¨ì)</h2>
            <div class="action-buttons">
                <button onclick="confirmExtractedData()">âœ… í™•ì • ë° ìµœì¢… ëª©ë¡ìœ¼ë¡œ ë¶„ë¦¬ (íšŒì°¨ ê¸°ë¡)</button>
                <button onclick="clearExtractedData()" class="delete-button">âŒ ì„ì‹œ ëª©ë¡ ë¹„ìš°ê¸° (ì¬ì¶”ì²¨)</button>
            </div>
            <div class="result-area" id="extractedDataList">
                <p>ì¶”ì¶œëœ ì„ì‹œ ë‹¹ì²¨ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
        
        <div class="control-group">
            <h2>4. ìµœì¢… í™•ì •ëœ ë‹¹ì²¨ì ëª©ë¡ (<span id="finalCount">0</span>ëª…, í˜„ì¬ ì§„í–‰ íšŒì°¨: <span id="currentRoundDisplay">1</span>)</h2>
            
            <div class="action-buttons-final">
                <button id="lockToggleButton" onclick="toggleFinalListLock()" class="lock-button">ğŸ”’ ëª©ë¡ ì ê¸ˆ</button>
                <button id="bulkDeleteButton" onclick="bulkDeleteFinalWinners()" class="delete-button" disabled>âœ” ì„ íƒ í•­ëª© ë³µìˆ˜ ì‚­ì œ</button>
                <button onclick="downloadResult()">ì—‘ì…€ íŒŒì¼ë¡œ ìµœì¢… ëª©ë¡ ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="final-list-area" id="finalDataList">
                <p>í™•ì •ëœ ë‹¹ì²¨ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <div class="add-data-input">
                <input type="text" id="finalDataInput" placeholder="ìˆ˜ë™ ì¶”ê°€ (ì˜ˆ: ì»¬ëŸ¼A: ê°’1, ì»¬ëŸ¼B: ê°’2)" disabled>
                <button id="addFinalDataButton" onclick="addFinalData()" disabled>+ ìˆ˜ë™ ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        let initialData = [];       // íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì›ë³¸ ë°ì´í„° (ì¤‘ë³µ ì œê±° ì „)
        let availableData = [];     // í˜„ì¬ ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„° (í™•ì • ëª©ë¡ ì œì™¸)
        let extractedData = [];     // í˜„ì¬ ì¶”ì¶œë˜ì–´ ì„ì‹œë¡œ ë³´ì—¬ì§€ëŠ” ë°ì´í„°
        let finalWinners = [];      // ìµœì¢… í™•ì •ëœ ë‹¹ì²¨ì ë°ì´í„°
        let availableHeaders = [];  // ì—‘ì…€ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ì‹¤ì œ ì»¬ëŸ¼ ì´ë¦„ ì €ì¥
        let currentRound = 1;       // í˜„ì¬ ì¶”ì²¨ íšŒì°¨ ì¹´ìš´í„°
        let isFinalListLocked = true; // ìµœì¢… ëª©ë¡ ì ê¸ˆ ìƒíƒœ (ê¸°ë³¸ê°’: ì ê¸ˆ)

        // ì´ˆê¸° ë¡œë“œ ë° UI ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            updateRemainingCount();
            document.getElementById('currentRoundDisplay').textContent = currentRound;
            
            // ì´ˆê¸° ìƒíƒœë¡œ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì…ë ¥ì°½ ì ê¸ˆ ì„¤ì •
            document.getElementById('lockToggleButton').textContent = 'ğŸ”’ ëª©ë¡ ì ê¸ˆ';
            document.getElementById('lockToggleButton').classList.remove('unlocked');
            document.getElementById('bulkDeleteButton').disabled = true;
            document.getElementById('finalDataInput').disabled = true;
            document.getElementById('addFinalDataButton').disabled = true;
        });

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì œí•œ ë¡œì§ (ìµœëŒ€ 2ê°œ)
        function setupCheckboxLimit() {
            const checkboxes = document.querySelectorAll('input[name="duplicateKey"]');
            
            checkboxes.forEach(checkbox => {
                // 1. ì„ íƒ ì œí•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                checkbox.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('input[name="duplicateKey"]:checked').length;
                    if (checkedCount > 2) {
                        this.checked = false; 
                        alert('ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì€ ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    // 2. ì‹¤ì‹œê°„ ì¤‘ë³µ ì œê±° ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œë§ˆë‹¤ ì‹¤í–‰)
                    updateDuplicateStatus();
                });
            });
        }
        
        // ì‹¤ì‹œê°„ ì¤‘ë³µ ì œê±° ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDuplicateStatus() {
            if (initialData.length === 0) return;

            // ì¤‘ë³µ ì œê±° ë° ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ëª©ë¡ ê°±ì‹ 
            availableData = removeDuplicates(initialData, finalWinners); 
            
            const duplicatedCount = initialData.length - availableData.length;
            const fileStatus = document.getElementById('fileStatus');

            fileStatus.textContent = `íŒŒì¼ì´ ë¡œë“œë˜ì—ˆê³ , í˜„ì¬ ì„ íƒëœ ê¸°ì¤€ìœ¼ë¡œ **${duplicatedCount}ê°œ**ì˜ ì¤‘ë³µì´ ì œê±°ë˜ì–´ **${availableData.length}ê°œ** ê³ ìœ  ë°ì´í„°ê°€ ì¶”ì²¨ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
            fileStatus.style.display = 'block';
            fileStatus.classList.remove('error');

            updateRemainingCount();
        }


        // ë‚¨ì€ ë°ì´í„° ìˆ˜ ì—…ë°ì´íŠ¸
        function updateRemainingCount() {
            document.getElementById('remainingCount').textContent = availableData.length;
            document.getElementById('finalCount').textContent = finalWinners.length;
            document.getElementById('currentRoundDisplay').textContent = currentRound;
        }

        // --- 1ë‹¨ê³„: íŒŒì¼ ë¡œë“œ ë° ì»¬ëŸ¼ í‘œì‹œ (ì¸ì½”ë”© ì²˜ë¦¬ ê°•í™”) ---
        function loadFileAndShowColumns() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const fileStatus = document.getElementById('fileStatus');
            const checkboxContainer = document.getElementById('duplicateKeyCheckboxes');

            fileStatus.style.display = 'none';
            fileStatus.classList.remove('error');
            fileStatus.textContent = '';
            
            if (!file) {
                fileStatus.textContent = 'ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv');
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    let workbook;
                    
                    if (isCSV) {
                        const data = e.target.result;
                        workbook = XLSX.read(data, { type: 'binary', cellDates: true, raw: false, codepage: 65001 }); 
                    } else {
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                    }

                    const sheetName = workbook.SheetNames[0]; 
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false }); 

                    if (json.length > 0 && json[0].length > 0) {
                        availableHeaders = json[0]
                            .map(h => h ? String(h).trim() : '')
                            .filter(h => h.length > 0);
                        
                        checkboxContainer.innerHTML = '';
                        if (availableHeaders.length === 0) {
                             checkboxContainer.innerHTML = '<p>ìœ íš¨í•œ ì»¬ëŸ¼ í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                             return;
                        }
                        
                        availableHeaders.forEach(header => {
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" name="duplicateKey" value="${header}"> ${header}`;
                            checkboxContainer.appendChild(label);
                        });
                        setupCheckboxLimit(); // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •

                        const rawData = parseJsonToObjects(json, availableHeaders);
                        initialData = rawData; 
                        finalWinners = []; // ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ ìµœì¢… ëª©ë¡ ì´ˆê¸°í™”
                        currentRound = 1; // ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ íšŒì°¨ ì´ˆê¸°í™”
                        
                        updateDuplicateStatus(); // ì´ˆê¸° ì¤‘ë³µ ì œê±° ìƒíƒœ ì—…ë°ì´íŠ¸ (íŒŒì¼ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰)

                        renderFinalData(); // ìµœì¢… ëª©ë¡ ë¹„ìš°ê¸° (ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ)

                    } else {
                        fileStatus.textContent = 'ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        fileStatus.classList.add('error');
                        fileStatus.style.display = 'block';
                    }
                } catch (error) {
                    console.error(`Error reading file:`, error);
                    fileStatus.textContent = `íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. (CSV íŒŒì¼ì˜ ê²½ìš°, UTF-8ë¡œ ì €ì¥ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.)`;
                    fileStatus.classList.add('error');
                    fileStatus.style.display = 'block';
                }
            };
            
            if (isCSV) {
                reader.readAsBinaryString(file); 
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // JSON ë°°ì—´ì„ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function parseJsonToObjects(json, headers) {
            const data = [];
            for (let j = 1; j < json.length; j++) {
                const row = json[j];
                let rowObject = {};
                let hasData = false;
                
                headers.forEach((header, index) => {
                    const value = row[index] !== undefined && row[index] !== null ? String(row[index]).trim() : ''; 
                    rowObject[header] = value;
                    if (value.length > 0) {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                   data.push(rowObject);
                }
            }
            return data;
        }
        
        // ì¤‘ë³µ ì œê±° ë° í™•ì • ëª©ë¡ ì œì™¸ ë¡œì§
        function removeDuplicates(dataArray, excludeArray) {
             const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);

             if (selectedKeys.length === 0) {
                 return dataArray.filter(row => Object.values(row).some(v => String(v).trim().length > 0));
             }

             const uniqueData = {};
             
             const excludedKeys = new Set();
             excludeArray.forEach(row => {
                 const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                 if (key.replace(/\|\|\|/g, '').length > 0) {
                     excludedKeys.add(key);
                 }
             });

             dataArray.forEach(row => {
                 const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                 
                 if (key.replace(/\|\|\|/g, '').length > 0 && !excludedKeys.has(key)) {
                     uniqueData[key] = row; 
                 }
             });
             
             return Object.values(uniqueData);
        }

        // --- 2ë‹¨ê³„: ì¤‘ë³µ ì œê±° ë° ì¶”ì¶œ ---
        function processAndExtract() {
            const extractCount = parseInt(document.getElementById('extractCount').value);
            const fileStatus = document.getElementById('fileStatus');
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            
            fileStatus.style.display = 'none';

            if (initialData.length === 0 || availableHeaders.length === 0) {
                fileStatus.textContent = 'ë¨¼ì € íŒŒì¼ì„ ë¡œë“œí•˜ê³  ì»¬ëŸ¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (selectedKeys.length === 0) {
                fileStatus.textContent = 'ì¤‘ë³µ ì œê±° ê¸°ì¤€ ì»¬ëŸ¼ì„ 1ê°œ ë˜ëŠ” 2ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }
            if (extractCount <= 0 || isNaN(extractCount)) {
                fileStatus.textContent = 'ìœ íš¨í•œ ì¶”ì¶œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                return;
            }

            // ìµœì‹  ì¤‘ë³µ ì œê±° ë° í™•ì • ëª©ë¡ ì œì™¸í•˜ì—¬ ê°±ì‹ 
            availableData = removeDuplicates(initialData, finalWinners); 
            
            if (availableData.length === 0) {
                fileStatus.textContent = 'ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                fileStatus.classList.add('error');
                fileStatus.style.display = 'block';
                renderExtractedData();
                return;
            }

            let dataToExtract = [...availableData];
            let actualCount = Math.min(extractCount, dataToExtract.length);
            
            const shuffled = dataToExtract.sort(() => 0.5 - Math.random());
            extractedData = shuffled.slice(0, actualCount);

            renderExtractedData();
            updateRemainingCount();
            
            fileStatus.textContent = `${availableData.length}ê°œì˜ ë°ì´í„° ì¤‘ ${extractedData.length}ê°œë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì •í•´ì£¼ì„¸ìš”. (í˜„ì¬ ${currentRound}íšŒì°¨)`;
            fileStatus.classList.remove('error');
            fileStatus.style.display = 'block';
        }

        // --- 3ë‹¨ê³„: UI ë Œë”ë§ (í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ê°œì„ ) ---

        function renderExtractedData() {
            const extractedDataListDiv = document.getElementById('extractedDataList');
            extractedDataListDiv.innerHTML = ''; 

            if (extractedData.length === 0) {
                extractedDataListDiv.innerHTML = '<p style="padding: 15px;">ì¶”ì¶œëœ ì„ì‹œ ë‹¹ì²¨ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            extractedDataListDiv.appendChild(createDataTable(extractedData, true));
        }
        
        function renderFinalData() {
            const finalDataListDiv = document.getElementById('finalDataList');
            finalDataListDiv.innerHTML = ''; 

            if (finalWinners.length === 0) {
                finalDataListDiv.innerHTML = '<p style="padding: 15px;">í™•ì •ëœ ë‹¹ì²¨ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            finalDataListDiv.appendChild(createDataTable(finalWinners, false));
            updateRemainingCount();
        }

        // í…Œì´ë¸” ìƒì„± í—¬í¼ í•¨ìˆ˜
        function createDataTable(dataArray, isExtractedList) {
            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();
            
            const displayHeaders = isExtractedList 
                ? availableHeaders
                : [...availableHeaders, 'Winning Round', 'Entry Method']; 

            // í—¤ë” í–‰ ìƒì„±
            const headerRow = thead.insertRow();
            if (!isExtractedList) {
                 const selectAllHeader = document.createElement('th');
                 const selectAllCheckbox = document.createElement('input');
                 selectAllCheckbox.type = 'checkbox';
                 selectAllCheckbox.id = 'selectAllFinalWinners';
                 selectAllCheckbox.disabled = isFinalListLocked;
                 selectAllCheckbox.addEventListener('change', (e) => {
                     const checkboxes = document.querySelectorAll('input[name="finalWinnerSelection"]');
                     checkboxes.forEach(cb => {
                         if (!cb.disabled) cb.checked = e.target.checked;
                     });
                 });
                 selectAllHeader.appendChild(selectAllCheckbox);
                 headerRow.appendChild(selectAllHeader);
            }
            headerRow.insertCell().textContent = 'No.';
            displayHeaders.forEach(header => {
                headerRow.insertCell().textContent = header;
            });
            headerRow.insertCell().textContent = 'ê´€ë¦¬';

            // ë°ì´í„° í–‰ ìƒì„±
            dataArray.forEach((item, index) => {
                const dataRow = tbody.insertRow();
                
                // ìµœì¢… ëª©ë¡ì¼ ë•Œë§Œ ì²´í¬ë°•ìŠ¤ ì¶”ê°€
                if (!isExtractedList) {
                    const checkboxCell = dataRow.insertCell();
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'finalWinnerSelection';
                    checkbox.value = index; // ì¸ë±ìŠ¤ë¥¼ ê°’ìœ¼ë¡œ ì‚¬ìš©
                    checkbox.disabled = isFinalListLocked; // ì ê¸ˆ ìƒíƒœì— ë”°ë¼ ë¹„í™œì„±í™”
                    checkboxCell.appendChild(checkbox);
                }

                dataRow.insertCell().textContent = index + 1; // No.

                displayHeaders.forEach(header => {
                    const cell = dataRow.insertCell();
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.classList.add('data-input');
                    
                    if (!isExtractedList) { // ìµœì¢… ëª©ë¡ (Final List)
                        input.disabled = isFinalListLocked; // ì ê¸ˆ ìƒíƒœì— ë”°ë¼ ë¹„í™œì„±í™”
                        if (header === 'Winning Round' || header === 'Entry Method') {
                            input.value = item[header] || '';
                            input.readOnly = true; 
                            input.style.backgroundColor = '#f0f0f0';
                        } else {
                            input.value = item[header] || '';
                            input.onchange = (e) => {
                                item[header] = e.target.value.trim();
                            };
                        }
                    } else { // ì„ì‹œ ì¶”ì¶œ ëª©ë¡ (Extracted List)
                        input.value = item[header] || '';
                        input.onchange = (e) => {
                            item[header] = e.target.value.trim();
                        };
                    }
                    
                    cell.appendChild(input);
                });

                // ê´€ë¦¬ ë²„íŠ¼ ì…€
                const actionsCell = dataRow.insertCell();
                actionsCell.classList.add('col-actions');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ì‚­ì œ';
                
                if (!isExtractedList) {
                    deleteButton.disabled = isFinalListLocked; // ìµœì¢… ëª©ë¡ì¼ ê²½ìš° ì ê¸ˆ ìƒíƒœì— ë”°ë¼ ë¹„í™œì„±í™”
                    deleteButton.classList.add('delete-button');
                }
                
                deleteButton.onclick = () => {
                    if (isExtractedList) {
                        deleteData(extractedData, index, renderExtractedData);
                    } else if (!isFinalListLocked) {
                        const deletedItem = deleteData(finalWinners, index, renderFinalData);
                        if (deletedItem && deletedItem['Entry Method'] === 'Random Draw') {
                            initialData.push(deletedItem); 
                            updateDuplicateStatus(); // ì¤‘ë³µ ìƒíƒœ ì—…ë°ì´íŠ¸
                            alert('í™•ì • ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ë°ì´í„°ëŠ” ì´ì œ ì¬ì¶”ì²¨ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        } else if (deletedItem && deletedItem['Entry Method'] === 'Manual Add') {
                            updateDuplicateStatus(); // ì¤‘ë³µ ìƒíƒœ ì—…ë°ì´íŠ¸
                            alert('ìˆ˜ë™ ì¶”ê°€ëœ í•­ëª©ì´ ìµœì¢… ëª©ë¡ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                };
                actionsCell.appendChild(deleteButton);
            });

            return table;
        }

        // ë°ì´í„° ì‚­ì œ ë¡œì§ (ì¬í™œìš©)
        function deleteData(dataArray, index, renderCallback) {
            const deletedItem = dataArray.splice(index, 1)[0];
            renderCallback();
            return deletedItem;
        }

        // í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ìµœì¢… ëª©ë¡ìœ¼ë¡œ í™•ì •í•˜ê³  ì›ë³¸ì—ì„œ ì œê±°
        function confirmExtractedData() {
            if (extractedData.length === 0) {
                alert('í™•ì •í•  ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!isFinalListLocked) {
                alert('ê²½ê³ : ìµœì¢… ëª©ë¡ì´ ìˆ˜ì • í•´ì œ ìƒíƒœì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ ë¨¼ì € [ğŸ”’ ëª©ë¡ ì ê¸ˆ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ê·¼ í›„ í™•ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            const currentRoundNumber = currentRound;
            
            // 1. ìµœì¢… ëª©ë¡ì— ì¶”ê°€ (íšŒì°¨ ì •ë³´ì™€ ë°©ë²•ì„ ì¶”ê°€)
            const winnersToConfirm = extractedData.map(item => {
                const newItem = { ...item };
                newItem['Winning Round'] = currentRoundNumber;
                newItem['Entry Method'] = 'Random Draw';
                return newItem;
            });
            finalWinners.push(...winnersToConfirm);

            // 2. ì›ë³¸ ë°ì´í„° (initialData)ì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            const selectedKeys = Array.from(document.querySelectorAll('input[name="duplicateKey"]:checked')).map(cb => cb.value);
            if (selectedKeys.length > 0) {
                const extractedKeys = new Set(extractedData.map(row => 
                    selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||')
                ));

                initialData = initialData.filter(row => {
                    const key = selectedKeys.map(k => String(row[k] || '').trim().toLowerCase()).join('|||');
                    return !extractedKeys.has(key);
                });
            } else {
                alert('ê²½ê³ : ì¤‘ë³µ ì œê±° ê¸°ì¤€ì´ ì„ íƒë˜ì§€ ì•Šì•„, ì›ë³¸ ë°ì´í„°ì—ì„œ ì •í™•í•œ í•­ëª© ì œê±°ê°€ ì–´ë µìŠµë‹ˆë‹¤. ìµœì¢… ëª©ë¡ì—ë§Œ ì¶”ê°€í•˜ê³ , ì›ë³¸ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.');
            }

            // 3. ì¶”ì¶œëœ ëª©ë¡ ë¹„ìš°ê¸° ë° ë‹¤ìŒ íšŒì°¨ë¡œ ì¦ê°€
            extractedData = [];
            currentRound++; // íšŒì°¨ ì¦ê°€
            updateDuplicateStatus(); // ì¤‘ë³µ ìƒíƒœ ë° ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ê°±ì‹ 

            // 4. UI ê°±ì‹ 
            renderExtractedData();
            renderFinalData();
            alert(`ì´ ${finalWinners.length}ëª…ì˜ ë‹¹ì²¨ìê°€ ìµœì¢… í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¶”ì²¨ì€ ${currentRound}íšŒì°¨ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.`);
        }
        
        // í˜„ì¬ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ ì·¨ì†Œí•˜ê³  ì¬ì¶”ì²¨ ê°€ëŠ¥í•œ ë°ì´í„°ë¡œ ë˜ëŒë¦¼
        function clearExtractedData() {
            if (extractedData.length === 0) return;
            
            extractedData = [];
            renderExtractedData();
            alert('í˜„ì¬ ì¶”ì¶œëœ ëª©ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ì¶œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        }

        // --- ìµœì¢… ëª©ë¡ ê´€ë¦¬ ê¸°ëŠ¥ ---

        // ìµœì¢… ëª©ë¡ ì ê¸ˆ/í•´ì œ í† ê¸€
        function toggleFinalListLock() {
            isFinalListLocked = !isFinalListLocked;
            const lockButton = document.getElementById('lockToggleButton');
            const bulkDeleteButton = document.getElementById('bulkDeleteButton');
            const finalDataInput = document.getElementById('finalDataInput');
            const addFinalDataButton = document.getElementById('addFinalDataButton');

            if (isFinalListLocked) {
                lockButton.textContent = 'ğŸ”’ ëª©ë¡ ì ê¸ˆ';
                lockButton.classList.remove('unlocked');
                bulkDeleteButton.disabled = true;
                finalDataInput.disabled = true;
                addFinalDataButton.disabled = true;
                alert('ìµœì¢… ëª©ë¡ì´ ì ê¸ˆ ìƒíƒœë¡œ ì„¤ì •ë˜ì–´ ë°ì´í„° ë³´í˜¸ ì¤‘ì…ë‹ˆë‹¤.');
            } else {
                lockButton.textContent = 'ğŸ”“ ìˆ˜ì • í•´ì œ';
                lockButton.classList.add('unlocked');
                bulkDeleteButton.disabled = false;
                finalDataInput.disabled = false;
                addFinalDataButton.disabled = false;
                alert('ìµœì¢… ëª©ë¡ì´ ìˆ˜ì • í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ìˆ˜ì •, ì‚­ì œ, ìˆ˜ë™ ì¶”ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            }

            // UI ì „ì²´ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ Disabled ìƒíƒœë¥¼ ë°˜ì˜
            renderFinalData(); 
        }

        // ìµœì¢… í™•ì • ëª©ë¡ì— ìˆ˜ë™ ì¶”ê°€
        function addFinalData() {
            if (isFinalListLocked) return; // ì ê¸ˆ ìƒíƒœì—ì„œëŠ” ì‹¤í–‰ ë¶ˆê°€

            const newDataInput = document.getElementById('finalDataInput');
            const newValueString = newDataInput.value.trim();

            if (newValueString) {
                const parts = newValueString.split(',').map(part => part.trim()).filter(part => part.includes(':'));
                let newObject = {};
                let isValid = true;

                parts.forEach(part => {
                    const match = part.match(/(.+?)\s*:\s*(.*)/); 
                    if (match && match[1] && match[2]) {
                        const key = match[1].trim();
                        const value = match[2].trim();
                        newObject[key] = value;
                    } else {
                        isValid = false;
                    }
                });
                
                if (Object.keys(newObject).length > 0 && isValid) {
                    newObject['Winning Round'] = 'Manual';
                    newObject['Entry Method'] = 'Manual Add';

                    finalWinners.push(newObject);
                    updateDuplicateStatus(); 

                    newDataInput.value = ''; 
                    renderFinalData();
                    alert('ë°ì´í„°ê°€ ìµœì¢… ëª©ë¡ì— ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ìœ íš¨í•œ "ì»¬ëŸ¼: ê°’" ìŒ(ì˜ˆ: í…”ë ˆê·¸ë¨ ID: @user, í•¸ë“œí° ë²ˆí˜¸: 010-...)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }
        }
        
        // ì„ íƒëœ í•­ëª© ë³µìˆ˜ ì‚­ì œ
        function bulkDeleteFinalWinners() {
            if (isFinalListLocked) return; // ì ê¸ˆ ìƒíƒœì—ì„œëŠ” ì‹¤í–‰ ë¶ˆê°€
            
            const checkboxes = document.querySelectorAll('input[name="finalWinnerSelection"]:checked');
            if (checkboxes.length === 0) {
                alert('ì‚­ì œí•  í•­ëª©ì„ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`ì„ íƒëœ ${checkboxes.length}ê°œì˜ í•­ëª©ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // ì„ íƒëœ ì¸ë±ìŠ¤ë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì‚­ì œ (ì¸ë±ìŠ¤ê°€ ë°€ë¦¬ëŠ” ê²ƒì„ ë°©ì§€)
            const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);

            let restoredCount = 0;
            indicesToDelete.forEach(index => {
                const deletedItem = finalWinners.splice(index, 1)[0];
                
                if (deletedItem && deletedItem['Entry Method'] === 'Random Draw') {
                    initialData.push(deletedItem);
                    restoredCount++;
                }
            });

            updateDuplicateStatus(); // ì¤‘ë³µ ìƒíƒœ ë° ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„° ê°±ì‹ 
            renderFinalData(); // UI ê°±ì‹ 

            alert(`${indicesToDelete.length}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆê³ , ê·¸ ì¤‘ ${restoredCount}ê°œê°€ ì¬ì¶”ì²¨ ê°€ëŠ¥ ë°ì´í„°ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìµœì¢… í™•ì • ëª©ë¡ë§Œ)
        function downloadResult() {
            if (finalWinners.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ìµœì¢… í™•ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const exportData = finalWinners.map((item, index) => {
                 return { "No.": index + 1, ...item };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ìµœì¢…_ë‹¹ì²¨ì_ëª©ë¡");
            XLSX.writeFile(wb, "ìµœì¢…_ë‹¹ì²¨ì_ëª©ë¡.xlsx");
        }
    </script>
</body>
</html>
